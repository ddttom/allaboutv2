<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Default Test Author">
    <title>Bio Block Test</title>

    <!-- EDS Core Styles -->
    <link rel="stylesheet" href="/styles/styles.css">

    <style>
        /* EDS pattern - ensure body appears */
        body.appear {
            display: block;
        }

        /* Test page styling */
        body {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-section {
            margin: 3rem 0;
            padding: 2rem;
            border: 2px solid #ccc;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .test-section h2 {
            margin-top: 0;
            color: #333;
        }

        .test-description {
            color: #666;
            font-style: italic;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #fff;
            border-left: 4px solid #0078d4;
        }

        /* Highlight the bio blocks for testing */
        .bio {
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border: 1px dashed #0078d4;
        }
    </style>
</head>
<body>
    <h1>Bio Block Test Page</h1>
    <p>Testing the bio block with various configurations. Open DevTools Console to see detailed logs.</p>

    <!-- Test Case 1: Image Link Conversion -->
    <div class="test-section">
        <h2>Test Case 1: Image Link Conversion (Primary Test)</h2>
        <p class="test-description">
            ‚úÖ Tests that image links (URLs ending in .jpg, .png, etc.) are converted to &lt;img&gt; elements<br>
            ‚úÖ Verifies the original &lt;a&gt; tag is completely removed from the DOM
        </p>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div><a href="https://picsum.photos/200/200.jpg">Test Author</a></div>
                    <div>This bio has an image link that should be converted to an actual image element.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case 2: Regular Picture Element -->
    <div class="test-section">
        <h2>Test Case 2: Regular Picture Element</h2>
        <p class="test-description">
            ‚úÖ Tests with a standard &lt;picture&gt; element<br>
            ‚úÖ Author name should be extracted from image alt attribute
        </p>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div>
                        <picture>
                            <img src="https://picsum.photos/200/201.jpg" alt="Jane Doe">
                        </picture>
                    </div>
                    <div>Jane Doe is a senior developer with 10 years of experience.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case 3: Multiple Image Extensions -->
    <div class="test-section">
        <h2>Test Case 3: Different Image Extensions</h2>
        <p class="test-description">
            ‚úÖ Tests .png extension
        </p>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div><a href="https://picsum.photos/200/300.png">PNG Author</a></div>
                    <div>Testing with .png image link.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case 4: Hide Author Variant -->
    <div class="test-section">
        <h2>Test Case 4: Hide Author Variant</h2>
        <p class="test-description">
            ‚úÖ Tests the 'hide-author' class<br>
            ‚ùå Should NOT convert image links<br>
            ‚ùå Should NOT add author name
        </p>

        <div class="bio-wrapper">
            <div class="bio hide-author">
                <div>
                    <div><a href="https://picsum.photos/200/203.jpg">Hidden Author</a></div>
                    <div>This bio uses hide-author class. Link should NOT be converted.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case 5: Multiple Bios -->
    <div class="test-section">
        <h2>Test Case 5: Multiple Bio Blocks</h2>
        <p class="test-description">
            ‚úÖ Tests that multiple bio blocks work independently
        </p>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div><a href="https://picsum.photos/200/204.jpg">First Author</a></div>
                    <div>First bio instance.</div>
                </div>
            </div>
        </div>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div><a href="https://picsum.photos/200/205.jpg">Second Author</a></div>
                    <div>Second bio instance.</div>
                </div>
            </div>
        </div>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div><a href="https://picsum.photos/200/206.jpg">Third Author</a></div>
                    <div>Third bio instance.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case 6: Non-Image Link (Should Not Convert) -->
    <div class="test-section">
        <h2>Test Case 6: Non-Image Link</h2>
        <p class="test-description">
            ‚ùå Regular links (non-image URLs) should NOT be converted
        </p>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div><a href="https://example.com/profile">Profile Link</a></div>
                    <div>This link should remain as a link because it's not an image URL.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case 7: Highlighted Variant -->
    <div class="test-section">
        <h2>Test Case 7: Highlighted Variant</h2>
        <p class="test-description">
            ‚úÖ Tests the 'highlighted' variant (blue border on image)
        </p>

        <div class="bio-wrapper">
            <div class="bio highlighted">
                <div>
                    <div><a href="https://picsum.photos/200/207.jpg">Highlighted Author</a></div>
                    <div>This bio uses the highlighted variant.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Case 8: URL as Link Text (Production Bug) -->
    <div class="test-section">
        <h2>Test Case 8: URL as Link Text (Badly Formed - Production Issue)</h2>
        <p class="test-description">
            ‚ö†Ô∏è Tests the fix for when link text is a URL instead of author name<br>
            ‚úÖ Should ignore URL link text and use meta tag for author name<br>
            ‚úÖ Image should still be created correctly
        </p>

        <div class="bio-wrapper">
            <div class="bio">
                <div>
                    <div><a href="https://picsum.photos/200/208.jpg">https://picsum.photos/200/208.jpg</a></div>
                    <div>This bio has the URL as link text (badly formed content). Should use meta tag for author.</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadBlock } from '/scripts/aem.js';

        // CRITICAL: Add body.appear class FIRST
        document.body.classList.add('appear');

        // Get all bio blocks
        const bioBlocks = document.querySelectorAll('.bio');

        console.log('‚ïê'.repeat(60));
        console.log('üß™ BIO BLOCK TEST SUITE');
        console.log('‚ïê'.repeat(60));
        console.log(`Found ${bioBlocks.length} bio blocks to test\n`);

        // Track results
        const results = {
            total: bioBlocks.length,
            passed: 0,
            failed: 0,
            errors: []
        };

        // Load each block
        for (let i = 0; i < bioBlocks.length; i++) {
            const block = bioBlocks[i];
            const testNum = i + 1;

            try {
                console.group(`Test ${testNum}: ${block.classList.contains('hide-author') ? 'Hide Author' : block.classList.contains('highlighted') ? 'Highlighted' : 'Standard'}`);

                // Check for image link before decoration
                const imageLink = block.querySelector('a[href*=".jpg"], a[href*=".jpeg"], a[href*=".png"], a[href*=".gif"], a[href*=".webp"], a[href*=".svg"]');
                const hasHideAuthor = block.classList.contains('hide-author');

                if (imageLink) {
                    console.log('üì∏ Image link found:', imageLink.href);
                    console.log('   Link text:', imageLink.textContent);
                }

                // Add .block class and set blockName (mimics EDS decorateBlock)
                block.classList.add('block');
                block.dataset.blockName = 'bio';
                await loadBlock(block);

                // Verify results
                const imgAfter = block.querySelector('img');
                const linkAfter = block.querySelector('a');
                const authorName = block.querySelector('strong');

                console.log('\nüìä Results:');
                console.log('  Image created:', !!imgAfter);
                console.log('  Link removed:', !linkAfter || hasHideAuthor);
                console.log('  Author added:', !!authorName);

                if (imgAfter) {
                    console.log('  Image src:', imgAfter.src);
                    console.log('  Image alt:', imgAfter.alt);
                }

                if (authorName) {
                    console.log('  Author name:', authorName.textContent);
                }

                // Validate based on expectations
                let passed = true;

                if (hasHideAuthor) {
                    // hide-author should NOT convert links or add author
                    if (!linkAfter || authorName) {
                        console.error('‚ùå FAILED: hide-author should preserve links and not add author');
                        passed = false;
                    }
                } else if (imageLink && !hasHideAuthor) {
                    // Normal blocks with image links should convert them
                    if (linkAfter) {
                        console.error('‚ùå FAILED: Image link was not removed');
                        passed = false;
                    }
                    if (!imgAfter) {
                        console.error('‚ùå FAILED: Image was not created');
                        passed = false;
                    }
                }

                if (passed) {
                    console.log('‚úÖ PASSED');
                    results.passed++;
                } else {
                    results.failed++;
                    results.errors.push(`Test ${testNum} failed`);
                }

                console.groupEnd();

            } catch (error) {
                console.error(`‚ùå Test ${testNum} threw error:`, error);
                results.failed++;
                results.errors.push(`Test ${testNum}: ${error.message}`);
                console.groupEnd();
            }
        }

        // Final summary
        console.log('\n' + '‚ïê'.repeat(60));
        console.log('üìã FINAL RESULTS');
        console.log('‚ïê'.repeat(60));
        console.log(`Total tests: ${results.total}`);
        console.log(`‚úÖ Passed: ${results.passed}`);
        console.log(`‚ùå Failed: ${results.failed}`);

        if (results.errors.length > 0) {
            console.log('\nErrors:');
            results.errors.forEach(err => console.log(`  ‚Ä¢ ${err}`));
        }

        if (results.failed === 0) {
            console.log('\nüéâ ALL TESTS PASSED!');
        } else {
            console.log('\n‚ö†Ô∏è  SOME TESTS FAILED');
        }

        console.log('‚ïê'.repeat(60));
    </script>
</body>
</html>

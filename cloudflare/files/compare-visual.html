<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Worker Before/After Comparison</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #333;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #4a9eff;
            margin-bottom: 10px;
        }

        .header p {
            color: #888;
            font-size: 1.1em;
        }

        .controls {
            background: #252525;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input {
            flex: 1;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        button {
            padding: 12px 24px;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: #357abd;
        }

        button:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .status.success {
            background: #1a3d1a;
            color: #4ade80;
            border: 1px solid #2d5a2d;
        }

        .status.error {
            background: #3d1a1a;
            color: #f87171;
            border: 1px solid #5a2d2d;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: #252525;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            margin-bottom: 15px;
            color: #4a9eff;
            font-size: 1.5em;
        }

        .panel.before h2 {
            color: #f59e0b;
        }

        .panel.after h2 {
            color: #10b981;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #888;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .code-block {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            border: 1px solid #333;
            max-height: 400px;
            overflow-y: auto;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            font-weight: 600;
        }

        .stat-value.added {
            color: #10b981;
        }

        .stat-value.removed {
            color: #ef4444;
        }

        .stat-value.preserved {
            color: #4a9eff;
        }

        .highlight {
            background: #3d3d1a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #fbbf24;
        }

        .diff-summary {
            background: #2d2d3d;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .diff-summary h2 {
            color: #4a9eff;
            margin-bottom: 15px;
        }

        .diff-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .diff-item.success {
            background: #1a3d1a;
            color: #4ade80;
        }

        .diff-item.warning {
            background: #3d3d1a;
            color: #fbbf24;
        }

        .diff-item.info {
            background: #1a2d3d;
            color: #4a9eff;
        }

        .icon {
            font-size: 1.2em;
            font-weight: bold;
        }

        @media (max-width: 1024px) {
            .comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Cloudflare Worker Comparison</h1>
        <p>See exactly what transformations the worker applies</p>
    </div>

    <div class="controls">
        <div class="input-group">
            <input
                type="text"
                id="testUrl"
                placeholder="Enter test path (e.g., /blogs/ddt/ai/aem-sidekick-copilot)"
                value="/blogs/ddt/ai/aem-sidekick-copilot"
            >
            <button id="compareBtn" onclick="runComparison()">Compare</button>
        </div>
        <div id="status" class="status"></div>
    </div>

    <div class="comparison">
        <div class="panel before">
            <h2>üì§ BEFORE (Origin)</h2>

            <div class="section">
                <h3>Headers</h3>
                <div id="beforeHeaders" class="code-block">
                    <em>Click "Compare" to fetch data...</em>
                </div>
            </div>

            <div class="section">
                <h3>Metadata Stats</h3>
                <div id="beforeStats">
                    <div class="stat">
                        <span class="stat-label">JSON-LD scripts:</span>
                        <span class="stat-value" id="beforeJsonLd">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Error scripts:</span>
                        <span class="stat-value" id="beforeErrors">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Author meta tags:</span>
                        <span class="stat-value" id="beforeAuthor">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Description tags:</span>
                        <span class="stat-value" id="beforeDesc">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Social media tags:</span>
                        <span class="stat-value" id="beforeOg">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Body size:</span>
                        <span class="stat-value" id="beforeSize">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel after">
            <h2>üì• AFTER (Worker)</h2>

            <div class="section">
                <h3>Headers</h3>
                <div id="afterHeaders" class="code-block">
                    <em>Click "Compare" to fetch data...</em>
                </div>
            </div>

            <div class="section">
                <h3>Metadata Stats</h3>
                <div id="afterStats">
                    <div class="stat">
                        <span class="stat-label">JSON-LD scripts:</span>
                        <span class="stat-value" id="afterJsonLd">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Valid JSON-LD:</span>
                        <span class="stat-value" id="afterValid">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Author meta tags:</span>
                        <span class="stat-value" id="afterAuthor">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Description tags:</span>
                        <span class="stat-value" id="afterDesc">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Social media tags:</span>
                        <span class="stat-value" id="afterOg">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Body size:</span>
                        <span class="stat-value" id="afterSize">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="diff-summary" id="diffSummary" style="display: none;">
        <h2>üìä Transformation Summary</h2>
        <div id="diffItems"></div>
    </div>

    <script>
        const WORKER_URL = 'http://localhost:8787';
        const ORIGIN_URL = 'https://main--allaboutv2--ddttom.aem.live';

        async function runComparison() {
            const testPath = document.getElementById('testUrl').value;
            const btn = document.getElementById('compareBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = 'Fetching...';
            showStatus('Fetching responses...', 'success');

            try {
                // Fetch both responses
                const [originResp, workerResp] = await Promise.all([
                    fetch(ORIGIN_URL + testPath),
                    fetch(WORKER_URL + testPath)
                ]);

                const [originText, workerText] = await Promise.all([
                    originResp.text(),
                    workerResp.text()
                ]);

                // Analyze responses
                analyzeHeaders(originResp, workerResp);
                analyzeBody(originText, workerText);
                generateDiffSummary(originResp, workerResp, originText, workerText);

                showStatus('‚úì Comparison complete!', 'success');
            } catch (err) {
                showStatus('Error: ' + err.message, 'error');
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Compare';
            }
        }

        function analyzeHeaders(originResp, workerResp) {
            const beforeHeaders = document.getElementById('beforeHeaders');
            const afterHeaders = document.getElementById('afterHeaders');

            const relevantHeaders = ['access-control-allow-origin', 'content-type', 'age', 'x-robots-tag'];

            let beforeHtml = '';
            let afterHtml = '';

            relevantHeaders.forEach(header => {
                const originValue = originResp.headers.get(header);
                const workerValue = workerResp.headers.get(header);

                if (originValue) {
                    beforeHtml += `<div><strong>${header}:</strong> ${originValue}</div>`;
                }
                if (workerValue) {
                    afterHtml += `<div><strong>${header}:</strong> ${workerValue}</div>`;
                }
            });

            beforeHeaders.innerHTML = beforeHtml || '<em>No relevant headers</em>';
            afterHeaders.innerHTML = afterHtml || '<em>No relevant headers</em>';
        }

        function countOccurrences(text, pattern) {
            const matches = text.match(new RegExp(pattern, 'g'));
            return matches ? matches.length : 0;
        }

        function analyzeBody(originText, workerText) {
            // Before stats
            document.getElementById('beforeJsonLd').textContent = countOccurrences(originText, 'type="application/ld\\+json"');
            document.getElementById('beforeErrors').textContent = countOccurrences(originText, 'data-error.*article');
            document.getElementById('beforeAuthor').textContent = countOccurrences(originText, 'name="author"');
            document.getElementById('beforeDesc').textContent = countOccurrences(originText, 'name="description"');
            document.getElementById('beforeOg').textContent = countOccurrences(originText, 'property="og:');
            document.getElementById('beforeSize').textContent = originText.length.toLocaleString() + ' chars';

            // After stats
            const afterJsonLd = countOccurrences(workerText, 'type="application/ld\\+json"');
            const afterValid = countOccurrences(workerText, '@context.*schema.org');
            document.getElementById('afterJsonLd').textContent = afterJsonLd;
            document.getElementById('afterValid').textContent = afterValid;
            document.getElementById('afterValid').className = 'stat-value ' + (afterValid > 0 ? 'added' : '');

            const afterAuthor = countOccurrences(workerText, 'name="author"');
            document.getElementById('afterAuthor').textContent = afterAuthor;
            document.getElementById('afterAuthor').className = 'stat-value ' + (afterAuthor === 0 ? 'removed' : '');

            const afterDesc = countOccurrences(workerText, 'name="description"');
            document.getElementById('afterDesc').textContent = afterDesc;
            document.getElementById('afterDesc').className = 'stat-value ' + (afterDesc === 0 ? 'removed' : '');

            const afterOg = countOccurrences(workerText, 'property="og:');
            document.getElementById('afterOg').textContent = afterOg;
            document.getElementById('afterOg').className = 'stat-value preserved';

            document.getElementById('afterSize').textContent = workerText.length.toLocaleString() + ' chars';

            const sizeDiff = workerText.length - originText.length;
            if (sizeDiff !== 0) {
                document.getElementById('afterSize').textContent += ` (${sizeDiff > 0 ? '+' : ''}${sizeDiff})`;
            }
        }

        function generateDiffSummary(originResp, workerResp, originText, workerText) {
            const diffSummary = document.getElementById('diffSummary');
            const diffItems = document.getElementById('diffItems');
            let html = '';

            // CORS
            if (workerResp.headers.get('access-control-allow-origin')) {
                html += '<div class="diff-item success"><span class="icon">‚úì</span><span>CORS headers added</span></div>';
            }

            // JSON-LD
            const validJsonLd = countOccurrences(workerText, '@context.*schema.org');
            if (validJsonLd > 0) {
                html += `<div class="diff-item success"><span class="icon">‚úì</span><span>JSON-LD generated (${validJsonLd} scripts)</span></div>`;
            }

            // Metadata cleanup
            const authorRemoved = countOccurrences(originText, 'name="author"') - countOccurrences(workerText, 'name="author"');
            if (authorRemoved > 0) {
                html += `<div class="diff-item success"><span class="icon">‚úì</span><span>Author metadata removed (${authorRemoved} tags)</span></div>`;
            }

            const descRemoved = countOccurrences(originText, 'name="description"') - countOccurrences(workerText, 'name="description"');
            if (descRemoved > 0) {
                html += `<div class="diff-item success"><span class="icon">‚úì</span><span>Description metadata removed (${descRemoved} tags)</span></div>`;
            }

            // Header cleanup
            if (!workerResp.headers.get('age')) {
                html += '<div class="diff-item success"><span class="icon">‚úì</span><span>"age" header removed</span></div>';
            }
            if (!workerResp.headers.get('x-robots-tag')) {
                html += '<div class="diff-item success"><span class="icon">‚úì</span><span>"x-robots-tag" header removed</span></div>';
            }

            // Social media preservation
            const ogCount = countOccurrences(workerText, 'property="og:');
            if (ogCount > 0) {
                html += `<div class="diff-item info"><span class="icon">‚óã</span><span>Social media tags preserved (${ogCount} og:* tags)</span></div>`;
            }

            diffItems.innerHTML = html || '<div class="diff-item warning"><span class="icon">‚ö†</span><span>No transformations detected</span></div>';
            diffSummary.style.display = 'block';
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
        }
    </script>
</body>
</html>
